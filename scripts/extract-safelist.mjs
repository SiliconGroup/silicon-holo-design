import { createGenerator } from '@unocss/core'
import presetUno from '@unocss/preset-uno'
import { readFileSync, writeFileSync, readdirSync, statSync } from 'fs'
import { join, resolve } from 'path'

const root = resolve(import.meta.dirname, '..')
const distDir = join(root, 'dist')

function collectJS(dir) {
  let content = ''
  for (const entry of readdirSync(dir)) {
    const full = join(dir, entry)
    if (statSync(full).isDirectory()) content += collectJS(full)
    else if (full.endsWith('.js')) content += readFileSync(full, 'utf-8') + '\n'
  }
  return content
}

const code = collectJS(distDir)

const uno = await createGenerator({
  presets: [presetUno()],
  theme: {
    colors: {
      holo: {
        cyan: 'rgba(0, 255, 255, %alpha)', 'cyan-dim': 'rgba(0, 204, 204, %alpha)',
        'cyan-dark': '#001a1a', blue: 'rgba(0, 136, 255, %alpha)',
        green: 'rgba(0, 255, 170, %alpha)', purple: 'rgba(170, 136, 255, %alpha)',
      },
      scene: { void: 'rgba(0, 10, 14, %alpha)', deep: 'rgba(0, 16, 24, %alpha)', surface: 'rgba(0, 26, 40, %alpha)' },
      status: { success: 'rgba(0, 255, 136, %alpha)', warning: 'rgba(255, 170, 0, %alpha)', error: 'rgba(255, 85, 102, %alpha)' },
    },
  },
  shortcuts: {
    'flex-center': 'flex items-center justify-center',
    'flex-between': 'flex items-center justify-between',
    'holo-text': 'bg-gradient-to-r from-holo-cyan via-holo-blue to-holo-green bg-clip-text text-transparent',
  },
})

const tokens = new Set()
await uno.applyExtractors(code, 'dist.js', tokens)
const result = await uno.generate(tokens)
const matched = [...result.matched].sort()

const output = `// Auto-generated by scripts/extract-safelist.mjs — do not edit manually
export const safelist: string[] = ${JSON.stringify(matched, null, 2)}
`

writeFileSync(join(root, 'src', 'preset', 'safelist.ts'), output)
console.log(`✓ Extracted ${matched.length} UnoCSS classes → src/preset/safelist.ts`)
